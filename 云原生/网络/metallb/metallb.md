# MetalLB

# 概述

MetalLB 支持对接 Loadbalancer 类型的 Service，可以给 Kubernetes 集群提供对外的网络负载均衡器。通过向外界提供可访问的 IP，暴露 Kubernetes 集群内部应用供外接访问。它有两个功能共同提供此服务：地址分配和外部公告。

## 地址分配

MetalLB 可以为负载均衡器分配一个对外访问的 IP，但是需要提前给他分配一个可用的 IP 池，他只会从这个 IP 池内分配 IP。IP 池可以是托管提供商提供的出租 IP 地址，可以租用如 /26 的 IP 空间（64 个地址），并将该范围提供给 MetalLB 以用于集群服务。IP 池也可以是一个私有地址空间（所谓的 RFC1918 地址）中选择的一系列 IP，并将它们分配给 MetalLB。此类地址只要仅向 LAN 提供集群服务，它们就可以正常工作。

## 外部公告

MetalLB 为服务分配外部 IP 地址后，需要让集群之外的网络知道该 IP 的存在。 MetalLB 使用标准网络或路由协议来实现此目的，具体取决于使用的模式：ARP、NDP 或 BGP。

### layer 2 模式

在 layer 2 下，MetalLB 使用 ARP （ IPv4 ） 请求和 IPv6 的 NDP （ IPv6 ） 请求来实现一个节点承担向本地网络通告服务的责任。这样子会导致服务 IP 的所有流量都会流向一个节点，这个节点的 kube-proxy 将流量传播到所有服务的 Pod。从这个意义上说，layer 2 没有实现负载均衡器的。相反，当 leader 节点由于某种原因发生故障时，它会使用 memberlist 检测到故障节点，自动进行故障转移，从故障节点接管 IP 地址的所有权。

layer 2 模式主要优点是它的通用性：它可以在任何以太网上工作，不需要特殊的硬件，甚至不需要花哨的路由器。但是 layer 2 模式有两个主要限制：单节点瓶颈和潜在的缓慢故障转移。

如上所述，在 layer 2 模式中，单个 leader 节点接收服务 IP 的所有流量，这意味着服务的入口带宽仅限于单个节点的带宽。这是使用 ARP 和 NDP 引导流量的基本限制。

当故障转移时，MetalLB 会发送未经请求的 2 层数据包，来通知客户端与服务 IP 关联的 MAC 地址已更改。大多数操作系统都能正确处理“无偿”数据包，并及时更新其邻居缓存。在这种情况下，故障转移会在几秒钟内发生。然而，有些系统要么根本不实现无偿处理，要么存在延迟缓存更新的错误实现。

为了最大限度地减少故障转移对客户端的影响，建议在更换领导权后让旧的 leader 节点保持运行几分钟，以便它可以继续为旧客户端转发流量，直到它们的缓存刷新。

### BGP 模式

在 BGP 模式下，集群中的每个节点都会与网络路由器建立 BGP 对等会话，并使用该对等会话通告外部集群服务的 IP。假设路由器配置为支持多路径，这将实现真正的负载平衡：MetalLB 发布的路由彼此等效，除了下一跳之外。 这意味着路由器将一起使用所有下一跳，并在它们之间进行负载平衡。数据包到达节点后，kube-proxy 负责流量路由的最后一跳，将数据包发送到服务中的一个特定 pod。

高性能路由器会使用数据包哈希来作为传播连接的方式。 对于每个数据包，他们提取一些字段，并将这些字段用作“种子”来确定性地选择可能的后端之一。 如果所有字段都相同，则将选择相同的后端。使用怎样的哈希方法取决于路由器硬件和软件。 两个典型的选项是 3 元组和 5 元组哈希。 3 元组使用 (protocol, source-ip, dest-ip) 作为键，这意味着两个唯一 IP 之间的所有数据包都将发送到同一个后端。 5 元组哈希将源端口和目标端口添加到混合中，从而允许来自同一客户端的不同连接分布在集群中。这样子保证了每个连接的所有数据包都将定向到集群中的一个节点上。流量传播仅发生在不同连接之间，而不发生在一个连接内的数据包，有效规避了同一连接的数据包路由到不同节点上导致连接失败的情况。因为 Kubernetes 中的节点内流量路由不保证节点之间保持一致性。 这意味着如果将同一连接的数据包分散到多个集群节点上，两个不同的节点可能决定将同一连接的数据包路由到不同的 Pod，这将导致连接失败。

但是这样也有弊端，当会话中断、后端主机集合变动，连接的哈希值会被重新计算，连接会被转发到不同的后端，发生数据错误的问题。

为此可以采取以下的缓解措施：

+ BGP 路由器可以选择使用更稳定的 ECMP 哈希算法，使用这样的算法可以极大地减少后端集更改时受影响的连接数量；
+ 将服务部署到固定的尽可能小、可信任的主机池里；
+ 在流量“低谷”期间安排对服务部署的更改；
+ 将每个服务拆分成为两个使用不一样IP的kubernetes的Service，并且通过DNS优雅地将用户的流量逐步迁移到新的服务上；
+ 在客户端添加透明的重试逻辑，用于从突然的断开连接中正常恢复；
+ 将服务置于入口控制器后面。入口控制器本身可以使用 MetalLB 来接收流量，但 BGP 和您的服务之间有一个有状态层意味着您可以毫无顾虑地更改您的服务。 您只需要在更改入口控制器本身的部署时小心；
+ 对于低可用性的内部服务，是可以接受偶尔会出现重置连接的情况。

# 架构



MetalLB 由两部分组成：
+ Controller 负责监听 Service 变化，依据对应的 IP 池进行 IP 分配。
+ Speaker 负责监听 Service 变化，并依据具体的协议发起相应的广播或应答、节点的 leader 选举。

# 操作

## 安装


## 资源对象介绍


## 使用


# 添加、更新


# 删除


# memberlist


## 参考链接
+ https://metallb.universe.tf/